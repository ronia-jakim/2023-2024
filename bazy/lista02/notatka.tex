\documentclass{article}

\usepackage{../../template}

\geometry{
%  showframe,
  a4paper, 
  total={170mm, 257mm}, 
  top=20mm, 
  marginparwidth={0mm},
  left={20mm},
  %right={26mm},
  headsep=5mm
}

\usepackage{array}
\usepackage{multirow}

\renewcommand{\arraystretch}{1.2}

\usepackage{listings}
\lstset{%
    %backgroundcolor=\color{yellow!20},%
    basicstyle=\ttfamily,
    breaklines=true,
    frame=single,
    rulecolor=\color{red!60!black!90}
    }

% Add your keywords here, and have this in a separate file
% and include it in your preamble
\lstset{emph={%  
    pi, sigma, x, tau, gamma, count, join
    },
    emphstyle={\color{blue}\bfseries}%
}%

\title{Lista 2}
\author{Weronika Jakimowicz}
\date{07.03.2024}

\begin{document}
\maketitle

\begin{problem}
  Rozważmy relację $R(A, B, C)$. Napisz zapytanie algebry relacji oraz zapytanie rrd/rrk, które zwróci pusty wynik wtedy i tylko wtedy gdy para atrybutów $A$, $B$ jest kluczem relacji $R$.
\end{problem}

\begin{solution}
  \textbf{\color{green}ALGEBRA RELACJI}

  Pytamy, kiedy to co jest w kolumnach $A$ i $B$ nie jest unikalne dla danej krotki (nie jest kluczem). Ilość krotek mających daną parę w kolumnach $A$ i $B$ liczymy zapytaniem \lstinline{gamma A, B, C; count C -> nr (R)}. Chcemy zwracać pusty wynik, kiedy w kolumnie $nr$ widzimy $1$, czyli wystarczy zrobić \lstinline{sigma nr>1 (...)} i mamy gotowy wynik. W całości zapytanie algebry relacji prezentuje się następująco:
  \begin{lstlisting}
sigma nr > 1 (
  gamma A, B, C; count C -> nr (R)
)
  \end{lstlisting}

  \textbf{\color{green}RRK}
  
  W tym przypadku mamy troszkę szybsze rozwiązanie, bo od razu możemy spytać, czy istnieje inny element który spełnia pewne warunki:
  $$\{x\in R\;:\;(\exists\;y\in R\setminus\{x\})\;y.A=x.A\;\land\; y.B=x.B\;\land\;y.C\neq x.C\}$$
  
  \textbf{\color{green}RRD}
  
  Tutaj jest jeszcze szybciej, ale wolałam RRK
  $$\{a,b,c\;:\;R(a,b,c)\;\land\;(\exists c')\;c\neq c'\;\land\;R(a, b, c')\}$$
\end{solution}

\begin{problem}
  Rozważmy relację $R(A, B, C)$ oraz $S(X, Z)$, przy czym atrybut $A$ jest kluczem w $R$. Napisz zapytanie algebry relacji oraz zapytanie rrk/rrd, które zwróci pusty wynik wtedy i tylko wtedy, gdy atrybut $Z$ relacji $S$ jest kluczem obcym wskazującym na atrybut $A$ relacji $R$.
\end{problem}

\begin{solution}
  \textbf{\color{green}ALGEBRA RELACJI}

  Klucz obcy, to np. indeks studenta w tabeli ocen - wskazuje on wtedy na osobę w tabeli aktywnych studentów uniwersytetu, ale może się powtarzać w tabeli ocen.

  Możemy zacząć od znalezienia krotek, które mają ten sam element w kolumnie $A$ i kolumnie $S$ przy pomocy joina: \lstinline{R join A=Z S}. Nas interesują wszystkie te wpisy z relacji $S$, w których ta równość nie zachodzi. Rzutujemy więc wynik \lstinline{join} na kolumny $X$ i $Z$ i odejmujemy wynik od $S$: \lstinline{S - (pi X, Z (...))}. W całości dostajemy
  \begin{lstlisting}
  S - (pi X, Z (
    R join A=Z S
    )
  )
  \end{lstlisting}

  \textbf{\color{green}RRK}

  Wystarczy sprawdzić, czy nie istnieje element w $R$, który zgadza się z aktualnym elementem na kolumnie $Z$. Można skorzystać z praw de Morgana
  $$\{x\in S\;:\; \neg (\exists y\in R)\;x.Z=y.A\}=\{x\in S\;:\; (\forall\;y\in R)\;x.Z\neq y.A\}$$

  \textbf{\color{green}RRD}
  
  Tutaj nieco mniej elegancko jest zapisać przy pomocy $\forall$ moim zdaniem:
  \begin{align*}
    \{x, z\;&:\;S(x, z)\;\land\;\neg [(\exists a, b, c)\;R(a,b,c)\;\land \; a=z]\}=\\ 
    &=\{x,z\;:\;S(x,z)\;\land\;(\forall\;a, b, c)\;\neg R(a,b,c)\lor a\neq z\} 
  \end{align*}
\end{solution}

\begin{problem}
  Dane są relacje $R$, $S$ i $T$ o schematach $R=AB$, $S=B_1B_2$ i $T=BC$. Przeanalizuj znaczenie poniższych zapytań i postaraj się znaleźć naturalną interpretację dla relacji i zapytań w języku polskim. Zastanów się, czy są to formuły niezależne od dziedziny. Zapisz równoważne im formuły w algebrze relacji zawsze jeśli to możliwe.
  \begin{enumerate}
    \item $\{a\;:\;(\exists\;b)\;(R(a, b)\;\land \neg ((\exists a')\;a'>a\;\land (\exists b')\;R(a', b')))\}$
    \item $\{a, b\;:\;(\forall\;c)\;(T(c, a)\;\lor\;T(c, b)\;\lor\;(\forall d)\;\neg T(c, d))\}$
  \end{enumerate}
\end{problem}

\begin{solution}
  \textbf{\color{green}1. $\boldsymbol{\{a\;:\;(\exists\;b)\;(R(a, b)\;\land \neg ((\exists a')\;a'>a\;\land (\exists b')\;R(a', b')))\}}$}

  Wszystkie te elementy $a\in A$, dla których nie istnieje inny element $(a', b')$ dla którego $a'>a$. Czyli zwraca to największy element kolumny $A$.

  To chyba nie jest niezależne od dziedziny? Bo jeśli
  \begin{center}
    \begin{tabular}{ | m{0.13\textwidth} | m{0.2\textwidth} | }
      \hline 
      \multicolumn{2}{|c|}{R=A, B}\\ 
      \hline 
      A=Stopień & B=Przedmiot\\ 
      \hline 
      3 & B.D.\\ 
      \hline
      2 & AnalMat\\ 
      \hline
    \end{tabular}
  \end{center}
  To dziedzina aktywna ma $B=\{(3, \text{"B.D."}), (2, \text{"AnalMat"}))\}$ i możemy wziąć $D_1$ która ma dziedzinę aktywną z dodatkiem $B\cup \{(5, \text{"Euler"}\}$ a jako $D_2$ wziąć $B\cup \{(4, \text{"RP1R"}\}$ i wtedy wynik jest różny?

  Napisanie tego wyżej w języku algebry relacji to
  \begin{lstlisting}
pi R.A - (
  pi R.A 
  (R join R.A < R.a 
    (rho R.a <- R.A, R.b <-R.B (R)
  )
)
  \end{lstlisting}


  \textbf{\color{green}2. $\boldsymbol{\{a, b\;:\;(\forall\;c)\;(T(c, a)\;\lor\;T(c, b)\;\lor\;(\forall d)\;\neg T(c, d))\}}$}

  To są pary elementów $(a, b)$, gdzie $a,b\in C$ które albo zawsze pojawiają się w drugiej kolumnie, albo jeśli nie pojawiają się dla pewnej krotki w drugiej kolumnie, to ten element nigdy nie jest na pierwszym miejscu?

  Zwraca te elementy kolumny $C$, które pojawiają się w drugiej kolumnie $T$ dla wszystkich elementów z $B$ stojących na pierwszym miejscu kolumny $T$. I tutaj jeśli weźmiemy sobie $T=\emptyset$, to dla każdego $c\in B$ i dla każdego $d\in C$ mamy $\neq T(c, d)$, czyli jest to prawdą nawet jak wtłoczymy coś nieskończonego.
\end{solution}

\begin{problem}
  Zdecyduj, czy poniższe równości zachodzą. Zaprezentuj dowód lub kontrprzykład.
  \begin{itemize}
    \item $R\bowtie S=S\bowtie R$
    \item $R\bowtie (S\bowtie T)=(R\bowtie S)\bowtie T$
  \end{itemize}
\end{problem}

\begin{solution}
  $\boldsymbol{\color{green}R\bowtie S=S\bowtie R}$

  %Załóżmy, że $R$ ma atrybuty $A_1,...,A_k, B_1,..., B_n$, natomiast $S$ - atrybuty $A_1,..., A_k, C_1,..., C_m$.

  Jeśli kolejność kolumn w joinie nie ma znaczenia, to stwierdzenie jest prawdziwe. Wystarczy zapisać np. w RRK:
  $$R\bowtie S\equiv \{ t\;:\;(\exists r\in R)\;(\exists s\in S)\; r.(S\cap R)=s.(S\cap R)\;\land t.R=r\;\land t.S=s\}$$
  $$S\bowtie R\equiv \{ t\;:\;(\exists s\in S)\;(\exists r\in R)\; s.(S\cap R)=r.(S\cap R)\;\land t.S=s\;\land t.R=r\}$$
  i zauważyć, że $\land$ i $\exists$ są przemienne.

  $\boldsymbol{\color{green}R\bowtie(S\bowtie T)=(R\bowtie S)\bowtie T}$

  Tutaj chyba też mamy prawdę. Zauważmy, że definicja natural join tłumaczy się jako
  $$x\in R\cap (S\bowtie T)\iff [x\in R\cap (S\cup T)\;\land x.S=x.T]$$
  przy czym $R\cap (S\cup T)=(R\cap S)\cup (R\cap T)$. Co więcej, jeśli dla $b\in S\bowtie T$ mamy $x.(S\bowtie T)=b$, to istnieją $s, t$ takie, że $b.S=s$, $b.T=t$, $s.(S\cap T)=t.(S\cap T)$ oraz $x.S=s\land x.T=t$.

  Zapiszmy
  \begin{align*}
    R\bowtie(S\bowtie T)\equiv & \{a\;:\; (\exists\;r\in R)(\exists b\in S\bowtie T)\\ 
                               &\quad \quad \quad r.(R\cap (S\bowtie T))=b.(R\cap (S\bowtie T))\;\land a.R=r\;\land a.(S\bowtie T)=b\}\equiv\\
      \equiv&\{a\;:\;(\exists r\in R)(\exists s\in S)(\exists t\in T)\\ 
            &\quad \quad \quad r.((R\cap S)\cup (R\cap T))=s.((R\cap S)\cup (R\cap T))\;\land\\ 
            &\quad\quad\quad r.((R\cap S)\cup (R\cap T))=t.((R\cap S)\cup (R\cap T))\;\land \\ 
            &\quad\quad\quad r.S=r.T\;\land\;s.(S\cap T)=t.(S\cap T)\;\land a.R=r\;\land\; a.S=s\;\land a.T=t\}\equiv\\ 
        \equiv &\{a\;:\;(\exists r\in R)(\exists s\in S)(\exists t\in T)\\ 
               &\quad\quad\quad r.(R\cap S)=s.(R\cap S)\;\land\; r.(R\cap T)=t.(R\cap T)\;\land\\ 
               &\quad\quad\quad r.S=r.T\;\land s.(S\cap T)=t.(S\cap T)\;\land a.R=r\;\land\;a.S=s\;\land\; a.T=t
             \}
  \end{align*}
  i podobnie będzie jak napiszemy $(R\bowtie S)\bowtie T$

%
%  \begin{align*}
%    R\bowtie (S\bowtie T)\equiv&\{a\;:\;(\exists r\in R)\;(\exists b\in (S\bowtie T))\\ 
%                               &\quad\quad\quad r.(R\cap (S\bowtie T))=b.(R\cap (S\bowtie T))\;\land a.R=r\;\land\;a.(S\bowtie T)=b\}\equiv \\ 
%    \equiv&\{a\;:\;(\exists r\in R)\;(\exists b)\\ 
%          &\quad\quad\quad( (\exists s\in S)\;(\exists\;t\in T)\;s.(S\cap T)=t.(S\cap T)\;\land\; b.S=s\;\land b.T=t )\\ 
%          &\quad \quad\quad r.(R\cap (S\bowtie T))=b.(R\cap (S\bowtie T))\;\land a.R=r\;\land a.(S\bowtie T)=b
%        \}\quiv\\ 
%      \equiv& \{a\;:\;(\exists r\in R)(\exists\;s\in S)(\exists t\in T)\;s.(S\cap T)=t.(S\cap T)\;\land s \}
%  \end{align*}
\end{solution}

\begin{problem}
  Baza danych składa się z relacji, jara jara jara

  RRD lub RRK
\end{problem}

\begin{solution}
  \textbf{\color{green}1. Podaj dane aktorów (pseudonim, imię, nazwisko, rok urodzenia, narodowość), którzy pojawili się w filmach produkowanych tylko w jednym roku.}

  Troszkę oszukane podejście do RRK:
  \begin{align*}
    A-\{a\in A\;:\; &(\exists\;x\in R)\;(\exists\;y\in R-\{x\})\;x.psuedonim = a.pseudonim = y.pseudonim\;\land\; \\ 
                    &(\exists\;f1\in F)\;(\exists f2\in F-\{f_1\})\;f1.rokProd \neq f2.rokProd \;\land\; \\ 
                    &\{f1.idf, f2.idf\}=\{x.idf, y.idf\}\;
                                     \}
  \end{align*}

  Lub po (potencjalnie błędnym) przemieleniu przez prawa de Morgana:
  \begin{align*}
    \{a\in A\;:\; \neg [&(\exists\;x\in R)\;(\exists\;y\in R-\{x\})\;x.psuedonim = a.pseudonim = y.pseudonim\;\land\; \\ 
                    &(\exists\;f1\in F)\;(\exists f2\in F-\{f1\})\;f1.rokProd \neq f2.rokProd \;\land\; \\ 
                    &\{f1.idf, f2.idf\}=\{x.idf, y.idf\}]\;
                                     \}\equiv\\ 
      \equiv\{a\in A\;:\;& (\forall\;x\in R)\;(\forall\;y\in R-\{x\})\; x.pseudonim\neq a.psuedonim\neq y.pseudonim\;\lor\;\\ 
                         &(\forall\;f1\in F)(\forall\;f2\in F-\{f1\}) f1.rokProd=f2.rokProd\;\lor\; \{f1.idf, f2.idf\}\neq \{x.idf, y.idf\}  \}
  \end{align*}

  \textbf{\color{green}2. Podaj pełne krotki filmów, które są najnowszymi filmami reżyserów.}

  \begin{align*}
    \{f\in F\;:\; \neg&(\exists x\in F)\; f.rezyser = x.rezyser \;\land f.rokProd < x.rokProd\}\equiv \\ 
    \equiv \{f\in F\;:\;&(\forall\;x\in F)\;f.rezyser\neq x.rezyser\;\lor\;f.rokProd >= x.rokProd\}
  \end{align*}

  \textbf{\color{green}3. Dla każdego filmu znajdź aktora, który dostał najwyższą gażę w tym filmie (został najlepiej opłacony z obsady filmu). W relacji wynikowej podaj pseudonim aktora, idf oraz gażę.}

  \begin{align*}
    \{ps, i, g\;:\;&(\exists\;rl)\;R(ps,i,rl, g)\;\land\;(\forall \;ps2, rl2, g2)\; \neg R(ps2, i, rl2, g2)\;\lor \; g2<=g \}
  \end{align*}

  \textbf{\color{green}4. Podaj pełne krotki aktorów, którzy nigdy nie obniżyli swojej minimalnej gaży (w późniejszych latach mogła ona najwyżej rosnąć). Na wynik nie wpływają lata, w których aktor nie podał minimalnej gaży.}

  \begin{align*} 
    \{a\in A\;:\; \neg&(\exists\;x, y\in R)\;x.pseudonim=a.pseudonim=y.pseudonim\;\land\; x.gaza > y.gaza \;\land \; \\ 
                      &(\exists f, g\in F)\; f.idf=x.idf\;\land\;g.idf=y.idf\;\land\;f.rokProd < g.rokProd\}\equiv \\ 
      %\equiv \{a\in A\;:\; &(\forall\;x,y\in R)\; x.pseudonim\neq a.pseudonim\neq y.pseudonim\;\lor\;x.gaza <= y.gaza \lor (\forall\;f,g\in F)\;\}
  \end{align*}
\end{solution}

\end{document}
